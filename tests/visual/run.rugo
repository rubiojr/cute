#!/usr/bin/env rugo
# Cute visual test runner
#
# Builds and runs all visual tests under tests/visual/.
# Each test directory must contain a main.rugo that uses the
# cute test module.
#
# Usage:
#   rugo run tests/visual/run.rugo              # verify against references
#   rugo run tests/visual/run.rugo update       # regenerate reference images
#   rugo run tests/visual/run.rugo counter      # run a specific test (both backends)
#   rugo run tests/visual/run.rugo qt           # run only Qt tests
#   rugo run tests/visual/run.rugo gtk          # run only GTK tests
#   rugo run tests/visual/run.rugo qt counter   # run a single Qt test

use "os"
use "str"

# -- Parse arguments ----------------------------------------------------------

args = os.args()
update = false
test_filter = ""
backend_filter = ""

for arg in args
  if arg == "update"
    update = true
  end
  if arg == "qt" || arg == "gtk"
    backend_filter = arg
  end
  if arg != "update" && arg != "qt" && arg != "gtk"
    test_filter = arg
  end
end

# -- Configuration ------------------------------------------------------------

os.setenv("LC_ALL", "C.UTF-8")
if update
  os.setenv("CUTE_TEST_UPDATE", "1")
else
  os.setenv("CUTE_TEST_UPDATE", "")
end

passed = 0
failed = 0
errors = []
orig_dir = os.cwd()

# -- Run Qt tests -------------------------------------------------------------

if backend_filter == "" || backend_filter == "qt"
  os.setenv("QT_QPA_PLATFORM", "offscreen")

  qt_tests = os.glob("tests/visual/qt/*/main.rugo")
  for test_main in qt_tests
    dir = `dirname #{test_main}`
    name = `basename #{dir}`
    if test_filter != "" && name != test_filter
      next
    end

    puts "=== qt/#{name} ==="
    os.chdir(dir)
    bin = "#{name}_test"

    build_out = try `rugo build main.rugo -o #{bin} 2>&1` or nil
    if build_out == nil
      puts "  BUILD FAILED"
      failed += 1
      append(errors, "qt/#{name}: build failed")
      os.chdir(orig_dir)
      next
    end

    run_out = try `./#{bin} 2>/dev/null` or nil
    if run_out != nil
      puts run_out
      passed += 1
    else
      failed += 1
      append(errors, "qt/#{name}: test failed")
    end

    try os.remove(bin) or nil
    os.chdir(orig_dir)
  end

  os.setenv("QT_QPA_PLATFORM", "")
end

# -- Run GTK tests ------------------------------------------------------------

if backend_filter == "" || backend_filter == "gtk"
  # Use Cairo renderer to avoid GPU/Vulkan noise in headless containers
  os.setenv("GSK_RENDERER", "cairo")

  gtk_tests = os.glob("tests/visual/gtk/*/main.rugo")
  for test_main in gtk_tests
    dir = `dirname #{test_main}`
    name = `basename #{dir}`
    if test_filter != "" && name != test_filter
      next
    end

    puts "=== gtk/#{name} ==="
    os.chdir(dir)
    bin = "#{name}_test"

    build_out = try `rugo build main.rugo -o #{bin} 2>&1` or nil
    if build_out == nil
      puts "  BUILD FAILED"
      failed += 1
      append(errors, "gtk/#{name}: build failed")
      os.chdir(orig_dir)
      next
    end

    run_out = try `xvfb-run -a ./#{bin} 2>/dev/null` or nil
    if run_out != nil
      puts run_out
      passed += 1
    else
      failed += 1
      append(errors, "gtk/#{name}: test failed")
    end

    try os.remove(bin) or nil
    os.chdir(orig_dir)
  end
end

# -- Summary ------------------------------------------------------------------

puts ""
puts "=== Summary ==="
total = passed + failed
puts "#{passed}/#{total} test suites passed"

if failed > 0
  puts ""
  puts "Failures:"
  for err in errors
    puts "  #{err}"
  end
  os.exit(1)
end
